<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Qpart</title>
    <style>
      /* th {
        background-color: darkblue !important;
      } */
    </style>

    <meta charset="utf-8" />
    <meta name="title" content="Qpart" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Qpart" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="manifest" href="manifest.json" crossorigin="use-credentials" />
    <link rel="icon" href="img/favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />

    <link rel="stylesheet" href="lib/bootstrap.min.css?v=<%= version %>" />
    <link rel="stylesheet" href="lib/nprogress.min.css?v=<%= version %>" />
    <link rel="stylesheet" href="lib/jquery-ui.css?v=<%= version %>" />
    <link rel="stylesheet" href="lib/jquery.mobile.min.css?v=<%= version %>" />

    <link rel="stylesheet" href="lib/toastr.min.css?v=<%= version %>" />
    <link rel="stylesheet" href="lib/bootstrap-icons.css?v=<%= version %>" />
    <link rel="stylesheet" href="styles/basic.css?v=<%= version %>" />
    <link rel="stylesheet" href="styles/tables.css?v=<%= version %>" />
    <link rel="stylesheet" href="styles/mediaviewer.css?v=<%= version %>" />
  </head>
  <body>
    <div id="overlay"></div>

    <div id="container">
      <nav class="navbar navbar-custom navbar-dark bg-dark">
        <a class="navbar-brand" href="#">
          <img src="img/logo.png" width="30" height="30" id="logo" class="d-inline-block align-top noColorImg" alt="" />
          <span class="text-container">
            <span id="navbar-brand-text" class="text-animation">Qpart</span>
          </span>
        </a>

        <div id="group-navbar" style="display: none">
          <span id="navbar_text_stanok"></span>
          <!-- <span id="navbar_text"></span> -->

          <button id="exit" type="button" class="btn btn-outline-dark">Выход</button>

          <button
            class="navbar-toggler"
            type="button"
            id="btnBurger"
            data-toggle="collapse"
            data-target="#navbarText"
            aria-controls="navbarText"
            aria-expanded="false"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
        </div>

        <div class="collapse navbar-collapse" id="navbarText">
          <ul class="navbar-nav mr-auto" id="menu">
            <!-- Меню наполняется при загрузке страницы -->
          </ul>
        </div>
      </nav>

      <div id="content" class="page" style="display: none">
        <!-- загружается при переходе по меню -->
      </div>

      <style>
        #loginContainer {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          top: 0;

          width: 100%;
        }

        #login {
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 10px;
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -40%);
          z-index: 1;
        }

        .loginBtn {
          width: 40%;
          flex: 1;
          border: none;
          padding: 10px;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 10px;
        }

        .btnImg {
          width: 150px;
          background-color: darkgreen;
          border-radius: 20px;
          padding: 10px;
        }

        #loginByPassowrd {
          display: none;
          display: flex;
          width: 100%;
          align-items: center;
          justify-content: center;
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
        }

        .formContainer {
          padding: 10px;
        }

        .group-button {
          display: flex;
          gap: 10px;
        }

        #loginByPassowrd .form-group {
          display: flex;
          flex-direction: column;
          align-items: start;
        }

        #loginBtn,
        #cancelBtn {
          margin-top: 0;
          flex-direction: column;
          gap: 10px;
          display: flex;
          align-items: center;
        }
        .formBtn {
        }

        #video {
          position: fixed;
          width: 100%;
          height: 100%;
        }
      </style>

      <video id="video" style="display: none" autoplay></video>
      <div id="loginContainer">
        <div id="login" class="page">
          <button id="btnStartVideo" type="button" class="btn btn-lg loginBtn">
            <img class="btnImg" src="img/faceid.svg" alt="face id" />
            <div class="text">Face Id</div>
          </button>
          <button id="btnLoginPassword" type="button" class="btn btn-lg loginBtn">
            <img class="btnImg" src="img/login.svg" alt="login password" />
            <div class="text">Password</div>
          </button>
        </div>

        <div id="loginByPassowrd" style="display: none">
          <div class="formContainer" id="formContainer">
            <form>
              <div class="form-group">
                <label for="username">Логін</label>
                <input
                  type="text"
                  form-control-lg
                  class="form-control form-control-lg"
                  id="username"
                  name="username"
                  required
                  placeholder="логін"
                  autocomplete="off"
                />
              </div>
              <div class="form-group">
                <label for="password">Пароль</label>
                <div class="input-group mb-3">
                  <input
                    type="password"
                    class="form-control form-control-lg"
                    id="password"
                    name="password"
                    required
                    placeholder="пароль"
                    autocomplete="off"
                  />
                  <div class="input-group-append">
                    <span class="input-group-text">
                      <i class="bi bi-eye" id="toggle-password"></i>
                    </span>
                  </div>
                </div>
              </div>
              <div class="group-button">
                <button type="button" id="cancelBtn" class="btn btn-lg btn-secondary btn-block formBtn">Отмена</button>
                <button type="submit" id="loginBtn" class="btn btn-lg btn-success btn-block formBtn">Увійти</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div id="formMainCamera" style="display: none">
        <video id="mainCamera" autoplay></video>
        <span id="videoTimer">00:00</span>
        <div class="camera-controls">
          <button id="capturePhoto"><i class="bi bi-camera"></i></button>
          <button id="captureVideo"><i class="bi bi-record-fill"></i></button>
          <button id="stopVideo" style="display: none"><i class="bi bi-stop-fill"></i></button>
          <button id="closeCamera"><i class="bi bi-x-square"></i></button>
        </div>
        <div id="flash" class="flash"></div>
      </div>
    </div>

    <script>
      window.config = {
        testEnvironment: '<%= test %>',
        version: '<%= version %>',
        token: '<%= token %>',
      };
      const testEnvironment = window.config.testEnvironment;
      const version = window.config.version;
      const token = window.config.token;
    </script>

    <script src="lib/jquery-3.6.0.min.js?v=<%= version %>"></script>
    <script src="lib/nprogress.min.js?v=<%= version %>"></script>
    <script src="lib/bootstrap.bundle.min.js?v=<%= version %>"></script>
    <script src="lib/jquery-ui.min.js?v=<%= version %>"></script>
    <script src="lib/toastr.min.js?v=<%= version %>"></script>
    <script src="lib/jquery.cookie.js?v=<%= version %>"></script>
    <script src="lib/jquery.mask.js?v=<%= version %>"></script>
    <script src="lib/moment.js?v=<%= version %>"></script>
    <script src="lib/jquery.tablesorter.min.js?v=<%= version %>"></script>
    <script src="lib/jquery.tablesorter.widgets.min.js?v=<%= version %>"></script>
    <script src="lib/handlebars.min.js?v=<%= version %>"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <!-- <script src="lib/jquery.mobile.min.js?v=<%= version %>"></script> -->

    <script src="js/config.js?v=<%= version %>"></script>
    <script src="js/wss.js?v=<%= version %>"></script>
    <script src="js/login.js?v=<%= version %>"></script>
    <script src="js/tables.js?v=<%= version %>"></script>
    <script src="js/telegram.js?v=<%= version %>"></script>
    <script src="js/mediaviewer.js?v=<%= version %>"></script>
    <script src="js/storage.js?v=<%= version %>"></script>
    <script src="js/camera.js?v=<%= version %>"></script>
    <script src="js/swipe.js?v=<%= version %>"></script>

    <script>
      $(document).ready(function () {
        // history.pushState({ page: 'login' }, '', '');

        console.log('test, version', testEnvironment, version);
        if (testEnvironment) {
          const elements = document.querySelectorAll('.bg-dark');
          elements.forEach(element => {
            element.classList.remove('bg-dark');
            element.classList.add('test');
          });
        }

        if (token !== '') {
          $.cookie('token', token);
        }

        function openLoginPassword() {
          console.log('openLoginPassword');
          $('#login').hide();
          // $('#loginContainer').hide();
          $('#loginByPassowrd').show();
          $('#username').val('');
          $('#password').val('');
          // history.pushState({ page: 'loginByPassword' }, '', '');
        }

        function closeLoginPassword() {
          console.log('closeLoginPassword');

          $('#login').show();
          $('#loginByPassowrd').hide();
        }

        function closeLoginButtons() {
          console.log('closeLoginButtons');
          $('#loginContainer').hide();
        }

        $('#btnLoginPassword').on('click', function () {
          console.log('btnLoginPassword click');

          openLoginPassword();
        });

        // window.addEventListener('popstate', handlePopState);

        // function handlePopState(event) {
        //   const state = event.state;
        //   console.log('handlePopState state=', state);

        //   if (state) {
        //     switch (state.page) {
        //       case 'loginByPassword':
        //         openLoginPassword();
        //         break;
        //       case 'login':
        //         console.log('login');
        //         closeLoginPassword();
        //         break;
        //       default:
        //         break;
        //     }
        //   }
        // }

        $('#cancelBtn').on('click', function () {
          closeLoginPassword();
        });

        $('#loginBtn').on('click', function () {
          event.preventDefault();
          const username = $('#username').val();
          const password = $('#password').val();
          console.log('username, password', username, password);
          closeLoginPassword();

          universalRequest(
            'authorizationByPassword',
            'POST',
            { username: username, password: password },
            {},
            function onSuccess(response) {
              console.log('onSuccess by password', response);

              if (response.detectUser) {
                closeLoginPassword();
                closeLoginButtons();
                loadMenu(response.user, response.token, response.version);
                return;
              }
            },
            function onError(error) {
              console.log('Error callback:', error);
            },
            function onComplete() {
              console.log('Request completed');
            }
          );
        });

        $('#toggle-password').click(function () {
          $(this).toggleClass('bi-eye bi-eye-slash');
          var type = $(this).hasClass('bi-eye') ? 'password' : 'text';
          $('#password').attr('type', type);
        });

        function screenSize() {
          const screenWidth = window.screen.width;
          const screenHeight = window.screen.height;
          const availableScreenWidth = window.screen.availWidth;
          const availableScreenHeight = window.screen.availHeight;

          alert(
            'viewport width: ' +
              window.innerWidth +
              ', viewport height: ' +
              window.innerHeight +
              ', screen width: ' +
              screenWidth +
              ', screen height: ' +
              screenHeight +
              ', availableScreenWidth: ' +
              availableScreenWidth +
              ', availableScreenHeight: ' +
              availableScreenHeight
          );
        }

        function listenResize() {
          window.addEventListener('resize', function () {
            makeNavbarTextMove();
          });
        }

        listenResize();
      });
    </script>
  </body>
</html>
